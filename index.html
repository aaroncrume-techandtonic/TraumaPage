<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Overlooked Signs: Interactive Trauma Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Chosen Palette: Medicine Wheel Harmony */
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #1E293B; overflow: hidden; }
        
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 350px;
            max-height: 400px;
            margin: 0 auto;
        }
        
        .sign-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .sign-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .bg-east { background-color: #FEF3C7; }
        .bg-south { background-color: #FEE2E2; }
        .bg-west { background-color: #E2E8F0; }
        .bg-north { background-color: #F9FAFB; }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.5); opacity: 0.4; }
        }
        .breathing-circle { animation: breathe 8s infinite ease-in-out; }

        .book-content h1 { @apply text-4xl font-black mt-12 mb-8 text-slate-900 border-b-4 border-indigo-500 pb-4; }
        .book-content h2 { @apply text-2xl font-bold mt-12 mb-6 text-slate-800 flex items-center gap-2; }
        .book-content h3 { @apply text-xl font-bold mt-8 mb-4 text-indigo-600; }
        .book-content p { @apply mb-6 leading-relaxed text-slate-600 text-lg; }
        .book-content strong { @apply text-slate-900 font-bold; }
        .book-content ul { @apply list-disc ml-6 mb-8 space-y-3 text-slate-600 text-lg; }
        
        .active-tab { @apply bg-slate-800 text-white border-l-4 border-indigo-500; }
        
        .dedication-gradient {
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
        }

        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="flex h-screen">

    <!-- Sidebar Navigation -->
    <nav class="w-20 md:w-64 bg-slate-900 text-white flex flex-col flex-shrink-0 z-20 transition-all duration-300">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 rounded-full border-2 border-white/20 relative overflow-hidden flex items-center justify-center bg-slate-800">
                <div class="absolute top-0 right-0 w-1/2 h-1/2 bg-yellow-400 opacity-60"></div>
                <div class="absolute bottom-0 right-0 w-1/2 h-1/2 bg-red-500 opacity-60"></div>
                <div class="absolute bottom-0 left-0 w-1/2 h-1/2 bg-slate-900 opacity-60"></div>
                <div class="absolute top-0 left-0 w-1/2 h-1/2 bg-slate-100 opacity-60"></div>
            </div>
            <span class="font-bold text-lg hidden md:block text-slate-100">Trauma Compass</span>
        </div>

        <div class="flex-1 py-4 space-y-1 overflow-y-auto">
            <button onclick="switchView('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-4 px-6 py-4 hover:bg-slate-800 transition-colors active-tab">
                <i class="fa-solid fa-house w-6 text-center"></i>
                <span class="hidden md:block">Overview</span>
            </button>
            <button onclick="switchView('dedication')" id="nav-dedication" class="w-full flex items-center gap-4 px-6 py-4 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-heart w-6 text-center text-rose-400"></i>
                <span class="hidden md:block">Dedication</span>
            </button>
            <button onclick="switchView('identify')" id="nav-identify" class="w-full flex items-center gap-4 px-6 py-4 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-magnifying-glass w-6 text-center text-yellow-400"></i>
                <span class="hidden md:block">Identify (East)</span>
            </button>
            <button onclick="switchView('biology')" id="nav-biology" class="w-full flex items-center gap-4 px-6 py-4 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-brain w-6 text-center text-red-500"></i>
                <span class="hidden md:block">Biology (South)</span>
            </button>
            <button onclick="switchView('heal')" id="nav-heal" class="w-full flex items-center gap-4 px-6 py-4 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-seedling w-6 text-center text-slate-400"></i>
                <span class="hidden md:block">Healing (West)</span>
            </button>
            <button onclick="switchView('resources')" id="nav-resources" class="w-full flex items-center gap-4 px-6 py-4 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-hands-holding w-6 text-center text-white"></i>
                <span class="hidden md:block">Resources (North)</span>
            </button>
        </div>

        <div class="p-4 border-t border-slate-800">
            <button onclick="toggleReader()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg">
                <i class="fa-solid fa-book-open"></i>
                <span class="hidden md:block font-semibold">Reader Mode</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <header class="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between shadow-sm z-10">
            <div>
                <h1 id="view-title" class="text-xl font-bold text-slate-800">Series Dashboard</h1>
                <p id="view-desc" class="text-sm text-slate-500">Your roadmap from trauma to integrated healing.</p>
            </div>
            <div class="flex items-center gap-4 text-xs font-bold text-slate-400">
                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-400"></div> IDENTIFY</span>
                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div> UNDERSTAND</span>
                <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-slate-800"></div> INTEGRATE</span>
            </div>
        </header>

        <div id="scroll-area" class="flex-1 overflow-y-auto p-8 md:p-12">
            
            <!-- Dashboard View -->
            <div id="view-dashboard" class="space-y-12">
                <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm max-w-4xl">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">Welcome to the Healing Path</h2>
                    <p class="text-slate-600 leading-relaxed mb-6">
                        Trauma recovery is a journey through four quadrants. This application allows you to explore the physical signs, 
                        the neurobiology of your survival system, and the practical tools to reclaim your peace. 
                        Inspired by the Medicine Wheel, we treat healing as a holistic integration of Body, Mind, and Spirit.
                    </p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div onclick="switchView('identify')" class="p-4 rounded-2xl bg-yellow-50 border border-yellow-200 text-center cursor-pointer hover:shadow-md transition-all">
                            <div class="font-bold text-yellow-600">EAST</div>
                            <div class="text-xs text-slate-500">The Signs</div>
                        </div>
                        <div onclick="switchView('biology')" class="p-4 rounded-2xl bg-red-50 border border-red-200 text-center cursor-pointer hover:shadow-md transition-all">
                            <div class="font-bold text-red-600">SOUTH</div>
                            <div class="text-xs text-slate-500">The Brain</div>
                        </div>
                        <div onclick="switchView('heal')" class="p-4 rounded-2xl bg-slate-100 border border-slate-300 text-center cursor-pointer hover:shadow-md transition-all">
                            <div class="font-bold text-slate-700">WEST</div>
                            <div class="text-xs text-slate-500">The Tools</div>
                        </div>
                        <div onclick="switchView('resources')" class="p-4 rounded-2xl bg-white border border-slate-200 text-center cursor-pointer hover:shadow-md transition-all">
                            <div class="font-bold text-slate-400">NORTH</div>
                            <div class="text-xs text-slate-500">Support</div>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-8 max-w-6xl">
                    <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-2">Trauma Spectrum Profile</h3>
                        <p class="text-xs text-slate-500 mb-4">Focus areas: Event Impact vs. Relational/Identity Impact.</p>
                        <div class="chart-container">
                            <canvas id="mainRadarChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col justify-center">
                        <h3 class="font-bold text-slate-800 mb-6 text-center">Series Progress Overview</h3>
                        <div class="space-y-6">
                            <div>
                                <div class="flex justify-between text-xs font-bold mb-2 text-slate-600"><span>BOOK 1: SIGNS IDENTIFIED</span><span>17 / 17</span></div>
                                <div class="h-2 w-full bg-slate-100 rounded-full"><div class="h-full w-full bg-yellow-400 rounded-full"></div></div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs font-bold mb-2 text-slate-600"><span>BOOK 2: BIOLOGY MAPPED</span><span>100%</span></div>
                                <div class="h-2 w-full bg-slate-100 rounded-full"><div class="h-full w-full bg-red-500 rounded-full"></div></div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs font-bold mb-2 text-slate-600"><span>BOOK 3: TOOLS INTEGRATED</span><span>PROGRESSING</span></div>
                                <div class="h-2 w-full bg-slate-100 rounded-full"><div class="h-full w-2/3 bg-slate-800 rounded-full"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dedication View -->
            <div id="view-dedication" class="hidden animate-fade-in space-y-8">
                <div class="max-w-4xl mx-auto py-12 px-8 bg-white rounded-3xl border border-indigo-100 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-8 opacity-5 text-indigo-900"><i class="fa-solid fa-heart text-9xl"></i></div>
                    <div class="relative z-10 text-center">
                        <h2 class="text-indigo-900 text-3xl md:text-5xl font-black mb-6 tracking-tight">Dedicated to Jordan Lynn Stewart</h2>
                        <div class="w-24 h-1 bg-rose-400 mx-auto mb-8 rounded-full"></div>
                        
                        <div class="prose prose-indigo max-w-none text-slate-600 italic text-xl mb-12">
                            "A tribute to the heart that speaks the unspoken and the soul that dares to shine light into the shadows of silence."
                        </div>
                        
                        <div class="grid md:grid-cols-3 gap-6 text-left">
                            <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                                <i class="fa-solid fa-star text-indigo-600 mb-4 text-xl"></i>
                                <h4 class="font-bold text-indigo-900 mb-2 text-sm">Brave Advocacy</h4>
                                <p class="text-sm text-indigo-700 leading-relaxed">Honoring the intentional steps taken to raise awareness for Complex PTSD and the strength it takes to lead others toward the light.</p>
                            </div>
                            <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                                <i class="fa-solid fa-handshake-angle text-indigo-600 mb-4 text-xl"></i>
                                <h4 class="font-bold text-indigo-900 mb-2 text-sm">Cycle Breaker</h4>
                                <p class="text-sm text-indigo-700 leading-relaxed">For recognizing the hidden architecture of trauma and choosing the path of awareness over the comfort of silence.</p>
                            </div>
                            <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                                <i class="fa-solid fa-sun text-indigo-600 mb-4 text-xl"></i>
                                <h4 class="font-bold text-indigo-900 mb-2 text-sm">A Beacon of Hope</h4>
                                <p class="text-sm text-indigo-700 leading-relaxed">Dedicated with love to my cousin, whose journey inspires this work and provides a roadmap for others seeking their own peace.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Identify View -->
            <div id="view-identify" class="hidden space-y-8">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-r-2xl max-w-4xl">
                    <h3 class="text-yellow-800 font-bold mb-1">East: The Physical & Beginnings</h3>
                    <p class="text-sm text-yellow-700 leading-relaxed">Identification is the first act of rebellion. Click a sign to reveal the hidden logic behind the survival behavior.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="signs-grid">
                    <!-- JS Injected Cards -->
                </div>
            </div>

            <!-- Biology View -->
            <div id="view-biology" class="hidden space-y-8">
                <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-2xl max-w-4xl">
                    <h3 class="text-red-800 font-bold mb-1">South: The Emotional Engine</h3>
                    <p class="text-sm text-red-700 leading-relaxed">Understanding the "Engine Room." See how your nervous system shifts energy to keep you alive.</p>
                </div>
                <div class="grid lg:grid-cols-2 gap-8 max-w-6xl">
                    <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-4 text-sm uppercase tracking-wider">The Polyvagal Ladder</h3>
                        <div class="chart-container">
                            <canvas id="polyvagalBarChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-3xl border border-slate-200 space-y-6 shadow-sm">
                        <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wider">The Brain Hijack</h3>
                        <div class="p-4 rounded-xl border border-slate-100 bg-red-50">
                            <h4 class="font-bold text-red-700 text-sm">Amygdala (Smoke Detector)</h4>
                            <p class="text-xs text-red-600 mt-1">In trauma, it is hyper-sensitive, screaming "FIRE!" at the smell of burnt toast.</p>
                        </div>
                        <div class="p-4 rounded-xl border border-slate-100 bg-slate-50">
                            <h4 class="font-bold text-slate-700 text-sm">Prefrontal Cortex (The Pilot)</h4>
                            <p class="text-xs text-slate-500 mt-1">During triggers, the Pilot is kicked out of the cockpit. Logic goes offline.</p>
                        </div>
                        <div class="p-4 rounded-xl border border-slate-100 bg-indigo-50">
                            <h4 class="font-bold text-indigo-700 text-sm">Hippocampus (The Librarian)</h4>
                            <p class="text-xs text-indigo-600 mt-1">Fails to "date stamp" memories, making the past feel like it is happening NOW.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Healing View -->
            <div id="view-heal" class="hidden space-y-8">
                <div class="bg-slate-800 p-6 rounded-2xl text-white max-w-4xl shadow-lg">
                    <h3 class="font-bold mb-1">West: Mental & Introspection</h3>
                    <p class="text-sm text-slate-400 leading-relaxed">Healing is a daily practice. Use these tools to regulate your system when the alarm goes off falsely.</p>
                </div>
                <div class="grid md:grid-cols-2 gap-8 max-w-6xl">
                    <div class="bg-white p-12 rounded-3xl border border-slate-200 flex flex-col items-center text-center shadow-sm">
                        <h4 class="font-bold text-slate-800 mb-2">Paced Breathing</h4>
                        <p class="text-sm text-slate-500 mb-8">Follow the circle to activate your calm system.</p>
                        <div class="w-48 h-48 bg-indigo-50 rounded-full flex items-center justify-center relative">
                            <div class="w-24 h-24 bg-indigo-500/30 rounded-full breathing-circle"></div>
                            <span class="absolute text-indigo-800 font-bold uppercase tracking-widest text-xs">Breathe</span>
                        </div>
                        <div class="mt-8 grid grid-cols-3 gap-4 w-full text-xs font-bold text-slate-400">
                            <div>IN (4s)</div><div>HOLD (2s)</div><div>OUT (6s)</div>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                        <h4 class="font-bold text-slate-800 mb-4 text-sm uppercase tracking-wider">5-4-3-2-1 Grounding Checklist</h4>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                                <input type="checkbox" class="w-5 h-5 rounded text-indigo-600"><span class="text-sm text-slate-700">5 Things you can see</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                                <input type="checkbox" class="w-5 h-5 rounded text-indigo-600"><span class="text-sm text-slate-700">4 Things you can feel</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                                <input type="checkbox" class="w-5 h-5 rounded text-indigo-600"><span class="text-sm text-slate-700">3 Things you can hear</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                                <input type="checkbox" class="w-5 h-5 rounded text-indigo-600"><span class="text-sm text-slate-700">2 Things you can smell</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                                <input type="checkbox" class="w-5 h-5 rounded text-indigo-600"><span class="text-sm text-slate-700">1 Thing you can taste</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resources View -->
            <div id="view-resources" class="hidden space-y-8">
                <div class="max-w-4xl">
                    <h2 class="text-3xl font-bold mb-4 text-slate-800">North: Spiritual Wisdom & Support</h2>
                    <p class="text-slate-600 mb-8 leading-relaxed">You are not walking this path alone. Access immediate help and community resources here.</p>
                    <div id="resource-list" class="grid md:grid-cols-2 gap-4">
                        <!-- JS Injected Resources -->
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Reader Modal -->
    <div id="reader-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-5xl h-[90vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden relative border border-white/20">
            <header class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
                <div class="flex items-center gap-4">
                    <button onclick="toggleReader()" class="text-slate-400 hover:text-slate-800 transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                    <h3 class="font-bold text-slate-800">Trauma Compass Collection</h3>
                </div>
                <div class="flex items-center gap-3">
                    <div id="tts-indicator" class="hidden flex items-center gap-2 text-indigo-600 text-xs font-bold animate-pulse"><i class="fa-solid fa-waveform"></i> READING ALOUD</div>
                    <button onclick="toggleTTS()" id="tts-btn" class="flex items-center gap-2 bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full font-bold text-sm hover:bg-indigo-600 hover:text-white transition-all shadow-sm">
                        <i class="fa-solid fa-volume-high"></i> Listen
                    </button>
                    <button onclick="downloadFullCollection()" class="flex items-center gap-2 bg-slate-100 text-slate-700 px-4 py-2 rounded-full font-bold text-sm hover:bg-slate-800 hover:text-white transition-all shadow-sm">
                        <i class="fa-solid fa-download"></i> Download Full Series
                    </button>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-8 md:p-20 book-content" id="reader-content">
                <!-- Complete Book contents injected here -->
            </div>
            <div id="tts-loader" class="hidden absolute inset-0 bg-white/95 z-20 flex flex-col items-center justify-center">
                <i class="fa-solid fa-circle-notch animate-spin text-4xl text-indigo-600 mb-4"></i>
                <p class="font-bold text-slate-500 uppercase text-xs tracking-widest">Generating Empathic Audio...</p>
            </div>
        </div>
    </div>

    <!-- Toast for Notifications -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl hidden z-[60] text-center min-w-[200px]">
        <span id="toast-msg"></span>
    </div>

    <script>
        const apiKey = ""; // API key managed by environment

        const signs = [
            { title: "Over-explaining", icon: "fa-comments", scenario: "Spending 20 mins drafting a basic email.", logic: "Preemptively soothing others to stay safe from unpredictable moods." },
            { title: "Preemptive Self-Attack", icon: "fa-shield-halved", scenario: "Calling yourself 'stupid' before anyone else can.", logic: "Controlling the pain of criticism by inflicting it yourself first." },
            { title: "Ignoring Needs", icon: "fa-battery-empty", scenario: "Forgetting to eat because you are focused on tasks.", logic: "Deep belief that your needs are a burden to others." },
            { title: "Validation Blocks", icon: "fa-trophy", scenario: "Praise feels like a 'mistake' or evaporates instantly.", logic: "A 'shame filter' rejects positive information about the self." },
            { title: "Apologizing for Existing", icon: "fa-user-slash", scenario: "Saying 'sorry' for taking up physical space.", logic: "Core existential shame planted by early developmental trauma." },
            { title: "Splitting", icon: "fa-arrows-split-up-and-left", scenario: "Seeing a friend as 'evil' after one missed call.", logic: "Inability to handle nuance when safety is inconsistent." },
            { title: "Hypervigilance", icon: "fa-eye", scenario: "Scanning exits in a restaurant immediately.", logic: "Nervous system permanently set to Code Red for survival." },
            { title: "Attachment Extremes", icon: "fa-magnet", scenario: "Attaching instantly or isolating completely.", logic: "Extreme management of relational risk." },
            { title: "The 'Busy' Shield", icon: "fa-person-running", scenario: "Working constantly to avoid the silence.", logic: "Outrunning intrusive memories and hollow feelings." },
            { title: "Dissociation", icon: "fa-cloud", scenario: "Checking out mid-conversation or 'losing time'.", logic: "Mental escape when physical escape was impossible." },
            { title: "Survival Cynicism", icon: "fa-filter", scenario: "Thinking 'what do they want?' when someone is nice.", logic: "Kindness historically masked betrayal." },
            { title: "Crowded Loneliness", icon: "fa-users-slash", scenario: "Feeling an invisible barrier in a group.", logic: "Unresolved shame prevents authentic connection." },
            { title: "Trauma Rehearsal", icon: "fa-film", scenario: "Imagining worst-case scenarios commute.", logic: "Practicing the pain so it won't destroy you later." },
            { title: "Emotional Freeze", icon: "fa-icicles", scenario: "Mind goes blank when asked 'how do you feel?'.", logic: "Biological disconnection from body signals." },
            { title: "Disproportionate Reaction", icon: "fa-explosion", scenario: "Rage over a dropped glass.", logic: "Reacting to stored decades of stress, not the glass." },
            { title: "Comparison Loop", icon: "fa-scale-unbalanced", scenario: "Seeing others as whole and yourself as fragments.", logic: "Internal confirmation of chronic core brokenness." },
            { title: "Repetition Compulsion", icon: "fa-rotate-right", scenario: "Dating the same hurtful type of person.", logic: "Attempting to master the old trauma by recreating the battlefield." }
        ];

        const resources = [
            { name: "National Suicide Lifeline", contact: "988", note: "Anxiety, Depression, Crisis" },
            { name: "Crisis Text Line", contact: "HOME to 741741", note: "Grief, Anxiety, Trauma" },
            { name: "Domestic Violence Hotline", contact: "1-800-799-7233", note: "Safety Planning, PTSD" },
            { name: "SAMHSA Helpline", contact: "1-800-662-4357", note: "Treatment Referral, Delusions" }
        ];

        const fullBookText = `
            <h1>Book 1: The Hidden Language of Trauma</h1>
            <p>Trauma is not just a memory; it is an invisible architecture that changes how you perceive safety, connection, and your own worth. It manifests as overlooked signs easily mistaken for character flaws.</p>
            
            <h2>Part I: The 17 Overlooked Signs</h2>
            <p><strong>1. Over-explaining:</strong> You draft emails for 20 minutes to avoid "danger." This is a survival response to unpredictable moods, where you preemptively soothe others to stay safe.</p>
            <p><strong>2. Preemptive Self-Attack:</strong> You call yourself "stupid" before anyone else can. By inflicting the pain yourself first, you feel a distorted sense of control over external criticism.</p>
            <p><strong>3. Ignoring Needs:</strong> You forget to eat or sleep because you are focused on tasks or others. This stems from a deep belief that your needs are a burden to the world.</p>
            <p><strong>4. Validation Blocks:</strong> Praise feels like a "mistake" or evaporates instantly. A "shame filter" in your brain rejects positive information about your self-worth.</p>
            <p><strong>5. Apologizing for Existing:</strong> Saying "sorry" for taking up physical space or simply having a presence. This is core existential shame planted by early developmental trauma.</p>
            <p><strong>6. Splitting:</strong> Seeing the world as all-good or all-bad. Nuance feels unsafe when your early safety was inconsistent.</p>
            <p><strong>7. Hypervigilance:</strong> Scanning every exit and tracking every facial change in a room. Your nervous system is permanently set to Code Red for survival.</p>
            <p><strong>8. Attachment Extremes:</strong> You either dive into a relationship within 48 hours to secure "safety," or you keep everyone at a ten-foot distance. Both are desperate attempts to manage relational risk.</p>
            <p><strong>9. The "Busy" Shield:</strong> If you stop moving, the feelings catch up. You use work or tasks as a way to outrun intrusive memories and hollow feelings.</p>
            <p><strong>10. Dissociation:</strong> Checking out mid-conversation or "losing time." This was a brilliant survival tool when you couldn't physically escape; your mind learned to leave instead.</p>
            <p><strong>11. Survival Cynicism:</strong> Kindness feels like a trap. When someone is nice, your first thought is "what do they want from me?" because kindness historically masked betrayal.</p>
            <p><strong>12. The "Crowded Room" Loneliness:</strong> Even with loved ones, you feel an invisible barrier. You feel fundamentally different, as if you lack the "manual for life" everyone else has.</p>
            <p><strong>13. Trauma Rehearsal:</strong> You spend your commute imagining the worst-case scenarios. You believe that by "practicing" the pain, you won't be destroyed when it happens.</p>
            <p><strong>14. The Emotional Freeze:</strong> When asked "how do you feel?", your mind goes blank. This is biological disconnection from your body's emotional signals (Interoception).</p>
            <p><strong>15. The Disproportionate Reaction:</strong> A small mistake triggers a massive wave of rage. You are reacting to decades of stored stress that the immediate trigger just unlocked.</p>
            <p><strong>16. The Comparison Loop:</strong> You see "wholeness" in others and "fragments" in yourself, using their highlights to confirm your belief that you are uniquely broken.</p>
            <p><strong>17. Repetition Compulsion:</strong> You find yourself in the same hurtful relationship dynamics. Your subconscious is trying to "win" the old war by recreating the battlefield, hoping for a different outcome.</p>

            <h1>Book 2: The Neurochemical Hijack</h1>
            <p>Your brain is not your enemy; it is ultra-efficient at survival. When you experience chronic trauma, your priority shifts from thriving to staying alive. This shift physically changes your blood chemistry and neural pathways.</p>
            
            <h2>The Polyvagal Ladder</h2>
            <p>Recovery requires understanding the Autonomic Nervous System (ANS):</p>
            <ul>
                <li><strong>Ventral Vagal (Safety):</strong> Social engagement, steady heart rate, and connection.</li>
                <li><strong>Sympathetic (Fight/Flight):</strong> Mobilization, adrenaline spikes, and anxiety.</li>
                <li><strong>Dorsal Vagal (Freeze):</strong> Shutdown, numbness, and dissociation.</li>
            </ul>

            <h2>The Architecture of Trauma</h2>
            <p><strong>The Amygdala:</strong> In trauma, the brain's "Smoke Detector" is enlarged and hyper-sensitive. It screams "FIRE!" at the smell of burnt toast.</p>
            <p><strong>The Prefrontal Cortex:</strong> The "Pilot" handles logic. During a trigger, the Amygdala cuts the wires to the Pilot, leaving you unable to think logically.</p>
            <p><strong>The Hippocampus:</strong> The "Librarian" fails to "date stamp" memories, making 20-year-old trauma feel like it is happening right now.</p>
            <p><strong>Chemical Soup:</strong> Chronic levels of Cortisol cause inflammation and memory loss, while Adrenaline leads to "wired but tired" exhaustion.</p>

            <h1>Book 3: Reclaiming Your Life</h1>
            <p>Healing is not the absence of trauma; it is the presence of Safety. Because the thinking brain shuts down during a trigger, healing must happen from the "bottom-up"â€”starting with the body.</p>

            <h2>Daily Integration Tools</h2>
            <p><strong>Paced Breathing (TIPP):</strong> Splashing ice-cold water on your face triggers the "Mammalian Dive Reflex," which instantly reboots a panicked brain.</p>
            <p><strong>Grounding (5-4-3-2-1):</strong> Anchoring yourself in the present by engaging all five senses manually.</p>
            <p><strong>Sacred Communication:</strong> Instead of shame-based labels, use survival language. Script: "My nervous system is feeling Sympathetic right now. I need 15 minutes of quiet to find safety. It's not about you; it's about my system."</p>

            <h2>Post-Traumatic Growth</h2>
            <p>Survivors often develop "Superpowers": high empathy, the ability to read environments, and incredible resilience. Healing is becoming the integrated, wise, and powerful version of yourself forged in the fire of survival.</p>
            <p><em>Dedicated to Jordan Lynn Stewart.</em></p>
        `;

        let isReading = false;
        let audioContext = null;
        let currentSource = null;

        function init() {
            renderSigns();
            renderResources();
            initCharts();
        }

        function switchView(viewId) {
            document.querySelectorAll('#scroll-area > div').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            document.getElementById(`nav-${viewId}`).classList.add('active-tab');
            
            const titles = { 
                dashboard: "Series Dashboard", 
                dedication: "The Heart of the Project",
                identify: "Identify (East)", 
                biology: "Biology (South)", 
                heal: "Healing (West)", 
                resources: "Resources (North)" 
            };
            const descs = {
                dashboard: "Your roadmap from trauma to integrated healing.",
                dedication: "Honoring the advocacy of Jordan Lynn Stewart.",
                identify: "Recognizing the physical and behavioral manifestations of trauma.",
                biology: "How the brain and nervous system adapt to survive.",
                heal: "Daily tools and strategies for retraining the survival alarm.",
                resources: "Safe harbor and emergency assistance contacts."
            };
            
            document.getElementById('view-title').textContent = titles[viewId];
            document.getElementById('view-desc').textContent = descs[viewId];
            document.getElementById('scroll-area').scrollTop = 0;
        }

        function renderSigns() {
            const grid = document.getElementById('signs-grid');
            signs.forEach(s => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-3xl border border-slate-200 sign-card group shadow-sm";
                card.innerHTML = `<div class="w-10 h-10 rounded-xl bg-yellow-50 text-yellow-600 flex items-center justify-center mb-4 shadow-inner"><i class="fa-solid ${s.icon}"></i></div><h4 class="font-bold mb-2 text-slate-800">${s.title}</h4><p class="text-xs text-slate-500 hidden group-hover:block transition-all duration-300 leading-relaxed"><strong>Logic:</strong> ${s.logic}</p>`;
                grid.appendChild(card);
            });
        }

        function renderResources() {
            const list = document.getElementById('resource-list');
            resources.forEach(r => {
                list.innerHTML += `<div class="bg-white p-6 rounded-2xl border border-slate-200 flex justify-between items-center shadow-sm"><div><div class="font-bold text-slate-900">${r.name}</div><div class="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">${r.note}</div></div><div class="text-lg font-black text-indigo-600">${r.contact}</div></div>`;
            });
        }

        function initCharts() {
            new Chart(document.getElementById('mainRadarChart').getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['Flashbacks', 'Hypervigilance', 'Emotional Regulation', 'Self-Concept', 'Relationship Trust', 'Dissociation'],
                    datasets: [
                        { label: 'PTSD Focus', data: [90, 85, 40, 30, 40, 50], backgroundColor: 'rgba(239, 68, 68, 0.2)', borderColor: 'rgb(239, 68, 68)', pointBackgroundColor: 'rgb(239, 68, 68)' },
                        { label: 'CPTSD Focus', data: [50, 70, 95, 95, 90, 80], backgroundColor: 'rgba(234, 179, 8, 0.2)', borderColor: 'rgb(234, 179, 8)', pointBackgroundColor: 'rgb(234, 179, 8)' }
                    ]
                },
                options: { maintainAspectRatio: false, scales: { r: { angleLines: { color: '#e2e8f0' }, grid: { color: '#e2e8f0' }, ticks: { display: false } } }, plugins: { legend: { labels: { font: { family: 'Inter', weight: 'bold' } } } } }
            });

            new Chart(document.getElementById('polyvagalBarChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Ventral Vagal (Safety)', 'Sympathetic (Fight/Flight)', 'Dorsal Vagal (Freeze)'],
                    datasets: [
                        { label: 'Energy Level', data: [40, 95, 10], backgroundColor: ['#4ade80', '#ef4444', '#1e293b'], borderRadius: 4 },
                        { label: 'Safety Sense', data: [95, 10, 5], backgroundColor: ['#166534', '#991b1b', '#0f172a'], borderRadius: 4 }
                    ]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false }, border: { display: false } } }, plugins: { legend: { position: 'bottom', labels: { font: { family: 'Inter', weight: 'bold' } } } } }
            });
        }

        function toggleReader() {
            const modal = document.getElementById('reader-modal');
            const display = document.getElementById('reader-content');
            if (modal.classList.contains('hidden')) {
                display.innerHTML = fullBookText;
                modal.classList.remove('hidden');
            } else {
                stopTTS();
                modal.classList.add('hidden');
            }
        }

        function downloadFullCollection() {
            const content = document.getElementById('reader-content').innerText;
            const title = "Trauma Compass: The Complete Collection\nDedicated to Jordan Lynn Stewart\n\n";
            const separator = "\n\n" + "=".repeat(30) + "\n\n";
            
            const fullDoc = title + content;
            
            const blob = new Blob([fullDoc], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "Trauma_Compass_Complete_Collection.md";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast("Collection downloaded successfully.");
        }

        // --- FIXED TTS ENGINE ---

        async function fetchWithRetry(url, options, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status !== 429 && response.status < 500) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err.error?.message || `API Error ${response.status}`);
                    }
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                }
                await new Promise(r => setTimeout(r, delay));
                delay *= 2;
            }
            throw new Error("Service connection failed");
        }

        function splitTextIntoChunks(text, limit = 1200) {
            const chunks = [];
            let current = "";
            const sentences = text.match(/[^\.!\?]+[\.!\?]+/g) || [text];
            for (const s of sentences) {
                if ((current + s).length > limit) {
                    if (current) chunks.push(current.trim());
                    current = s;
                } else {
                    current += s;
                }
            }
            if (current) chunks.push(current.trim());
            return chunks;
        }

        async function toggleTTS() {
            if (isReading) { stopTTS(); return; }
            const text = document.getElementById('reader-content').innerText.trim();
            if (!text) return;

            const loader = document.getElementById('tts-loader');
            const indicator = document.getElementById('tts-indicator');
            const btn = document.getElementById('tts-btn');

            isReading = true;
            indicator.classList.remove('hidden');
            btn.innerHTML = '<i class="fa-solid fa-stop"></i> Stop';
            btn.classList.add('bg-red-500');

            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') await audioContext.resume();

                const chunks = splitTextIntoChunks(text);
                
                for (const chunk of chunks) {
                    if (!isReading) break;
                    loader.classList.remove('hidden');
                    await speakChunk(chunk);
                    loader.classList.add('hidden');
                }
            } catch (e) {
                console.error("TTS Logic Error:", e);
                showToast(e.message || "Audio service unavailable.");
                stopTTS();
            } finally {
                loader.classList.add('hidden');
                if (isReading && !currentSource) stopTTS();
            }
        }

        async function speakChunk(chunkText) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const res = await fetchWithRetry(url, {
                method: "POST", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Say in a calm, empathetic voice: ${chunkText}` }] }],
                    generationConfig: { 
                        responseModalities: ["AUDIO"], 
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } 
                    },
                    model: "gemini-2.5-flash-preview-tts"
                })
            });
            
            const result = await res.json();
            const pcmPart = result.candidates?.[0]?.content?.parts?.[0]?.inlineData;
            
            if (!pcmPart || !pcmPart.data) throw new Error("No audio data returned from API.");

            const sampleRate = parseInt(pcmPart.mimeType.split('rate=')[1]) || 24000;
            await playAudioPromise(pcmPart.data, sampleRate);
        }

        function playAudioPromise(base64, sampleRate) {
            return new Promise((resolve, reject) => {
                if (!isReading) return resolve();
                
                try {
                    const binary = atob(base64);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                    
                    const wav = createWav(bytes, sampleRate);
                    
                    audioContext.decodeAudioData(wav, buffer => {
                        if (!isReading) return resolve();
                        currentSource = audioContext.createBufferSource();
                        currentSource.buffer = buffer;
                        currentSource.connect(audioContext.destination);
                        currentSource.onended = () => {
                            currentSource = null;
                            resolve();
                        };
                        currentSource.start(0);
                    }, (err) => {
                        console.error("Buffer Decode Error:", err);
                        reject(new Error("Failed to decode audio buffer."));
                    });
                } catch (e) {
                    reject(e);
                }
            });
        }

        function stopTTS() {
            isReading = false;
            document.getElementById('tts-indicator').classList.add('hidden');
            document.getElementById('tts-loader').classList.add('hidden');
            const btn = document.getElementById('tts-btn');
            btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Listen';
            btn.classList.remove('bg-red-500');
            
            if (currentSource) { 
                try { currentSource.stop(); } catch(e) {}
                currentSource = null; 
            }
        }

        function createWav(pcm, rate) {
            const buf = new ArrayBuffer(44 + pcm.length);
            const v = new DataView(buf);
            const s = (o, str) => { for (let i = 0; i < str.length; i++) v.setUint8(o + i, str.charCodeAt(i)); };
            
            s(0, 'RIFF'); 
            v.setUint32(4, 36 + pcm.length, true); 
            s(8, 'WAVE'); 
            s(12, 'fmt '); 
            v.setUint32(16, 16, true);
            v.setUint16(20, 1, true); // PCM
            v.setUint16(22, 1, true); // Mono
            v.setUint32(24, rate, true); 
            v.setUint32(28, rate * 2, true); 
            v.setUint16(32, 2, true); 
            v.setUint16(34, 16, true); 
            s(36, 'data'); 
            v.setUint32(40, pcm.length, true);
            
            for (let i = 0; i < pcm.length; i++) v.setUint8(44 + i, pcm[i]);
            return buf;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 5000);
        }

        window.onload = init;
    </script>
</body>
</html>
